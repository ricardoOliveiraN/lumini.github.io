<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumini</title>
    <link rel="icon" href="./Imagens/iconeLuz.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/styleDash-Geral.css">
    <script src="./js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .class_kpiNumero {
            width: 80px;
        }
        .class_kpiTexto {
            font-size: 16.8px;
        }
    </style>
</head>
<script data-jsd-embedded data-key="c1c8f828-306c-4170-bbb7-1b74655c36af"
    data-base-url="https://jsd-widget.atlassian.com" src="https://jsd-widget.atlassian.com/assets/embed.js"></script>

<body onload="validarSessao(); luminosidadeSensor(); historicoAlertasSensorEspecifico(); luminosidadePorHora()">
    <main>
        <div class="class_menuLateral">
            <div class="class_LinksMenu">
                <ul>
                    <li><a href="TelaDash-Geral.html">
                            <img src="./Imagens/logo-sem-fundo.png" alt="Logotipo da empresa Lumini">
                        </a>
                    </li>
                    <li><a href="TelaDash-Geral.html">Dashboard</a></li>
                    <li><a href="CadastrarUsuario.html">Funcionários</a></li>
                    <li><a href="SimuladorCliente.html">Simulador</a></li>
                    <li><a href="TelaPerfil.html">Perfil</a></li>
                    <li id="id_btnSair"><a href="TelaLogin.html">Sair</a></li>
                </ul>
            </div>
        </div>
        </div>
        <div class="class_dashs">
            <div class="class_dashCima">
                <div class="class_tituloDash">
                    <h1>Dashboard Sensor 1.3</h1>
                </div>

                <div class="class_talhoesSelecionar">
                    <div class="class_talhoesSelecionarOpcoes">
                        <div class="class_talhoesSelecionarOpcao">
                            <a href="TelaDash-Talhao.html">Talhão 2</a>
                        </div>
                        <div class="class_talhoesSelecionarOpcao">
                            <a href="TelaDash-Geral.html">Todos Talhões</a>
                        </div>
                    </div>
                </div>

            </div>
            <!-- <div class="class_dashBaixo"> -->
            <div class="class_talhoesGraficosContainer">
                <!-- <div class="class_talhoesGraficosTitulo">
                            Todos os Talhões
                        </div> -->
                <div class="class_talhoesGraficos">
                    <div class="class_talhoesGrafico class_talhoesGrafico1">
                        <canvas id="myChartA" style="position: relative; height: 40.8vh; width: 34.7vw;"></canvas>
                    </div>
                    <div class="class_talhoesGrafico class_talhoesGrafico2">
                        <canvas id="myChartB"
                            style="position: relative; height: 40.8vh; width: 34.7vw; margin: 24px 0px;"></canvas>
                    </div>
                </div>
            </div>
            <!-- </div> -->
            <div class="container-AlertaeSelecionar">
                <div class="class_talhoesSelecionar" style="width: 55%;">
                    <div class="class_kpisMenu">
                        <div class="class_kpi class_kpi1">
                            <div class="class_kpiNumero" style="width: auto;">
                                <span id="span_mediaLuminosidade" style="margin: 10px;">1640</span>
                            </div>
                            <div class="class_kpiTexto">
                                <span>Média Luminosidade</span>
                            </div>
                        </div>
                        <div class="class_kpi class_kpi1">
                            <div class="class_kpiNumero">
                                <span id="span_mediaHoras">15,87</span>
                            </div>
                            <div class="class_kpiTexto">
                                <span>Média horas com luz</span>
                            </div>
                        </div>
                        <!-- </div> -->
                        <!-- </div> -->
                    </div>
                </div>
                <div class="class_sensorAlertas">
                    <table>
                        <thead id="historico_Alertas">
                            <tr class="tituloAlerta">
                                <th>Tipo</th>
                                <th>Luminosidade</th>
                                <th>Horário</th>
                            </tr>
                        </thead>
                    </table>
                </div>

            </div>
        </div>

    </main>
</body>

</html>

<script>

    var dataValues = [0, 0, 0, 0, 0, 400, 3000, 10000, 20000, 30000, 40000, 45000, 50000, 45000, 40000, 30000, 20000, 10000, 10000, 10000, 10000, 0, 0];
    var backGroundValues = [];
    var qtdVezes = 0;

    for (var contador = 0; contador < dataValues.length; contador++) {

        if (dataValues[contador] == 10000 && dataValues[contador + 1] == 10000) {

            backGroundValues.push('rgb(255, 0, 0)');
        } else {

            backGroundValues.push('rgba(75, 192, 192, 0.6)');
        }

    }




    // GRAFICO EM TEMPO REAL INDEX
    var sensorAnalogico = new Chart(document.getElementById('sensorAnalogico').getContext('2d'), {
        type: 'line',
        data: {
            datasets: [{
                label: 'Sensor 1.2',
                borderColor: '#FF9800',
                backgroundColor: '#FF9800'
            }]
        },
        options: {
            scales: {
                x: {
                    beginAtZero: true
                },
                y: {
                    title: {
                        display: true,
                        text: '(Lux)'
                    },
                    beginAtZero: true,
                },
            },
        }
    })


    var paginacao = {};
    var tempo = {};


    function obterDados(grafico, endpoint) {
        fetch('http://localhost:3300/sensores/' + endpoint)
            .then(response => response.json())
            .then(valores => {
                if (paginacao[endpoint] == null) {
                    paginacao[endpoint] = 0;
                }
                if (tempo[endpoint] == null) {
                    tempo[endpoint] = 0;
                }


                var ultimaPaginacao = paginacao[endpoint];
                paginacao[endpoint] = valores.length;
                valores = valores.slice(ultimaPaginacao);


                valores.forEach((valor) => {
                    if (grafico.data.labels.length == 10 && grafico.data.datasets[0].data.length == 10) {
                        grafico.data.labels.shift();
                        grafico.data.datasets[0].data.shift();
                    }


                    grafico.data.labels.push(tempo[endpoint]++);
                    grafico.data.datasets[0].data.push(parseFloat(valor));
                    grafico.update();
                });
            })
            .catch(error => console.error('Erro ao obter dados:', error));
    }


    setInterval(() => {
        obterDados(sensorAnalogico, 'analogico')
    }, 1000);

    // ATE AQUI O GRAFICO
</script>

<script src="./js/funcDashSensor.js"></script>